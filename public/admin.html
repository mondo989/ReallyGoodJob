<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - ReallyGoodJob</title>
    <link rel="stylesheet" href="/css/main.css">
    <script src="/js/theme.js"></script>

</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="header__title">ReallyGoodJob Admin</h1>
            <div class="header__controls">
                <button 
                    data-theme-toggle 
                    class="theme-toggle" 
                    aria-label="Toggle dark mode"
                    title="Toggle dark mode"
                >
                    <span class="theme-toggle__icon theme-toggle__sun">‚òÄÔ∏è</span>
                    <span class="theme-toggle__icon theme-toggle__moon">üåô</span>
                </button>
                <span id="adminEmail" class="text-secondary"></span>
                <div class="flex gap-3">
                    <a href="/dashboard" class="btn btn--secondary">Dashboard</a>
                    <button id="logoutBtn" class="btn btn--error">Logout</button>
                </div>
            </div>
        </header>

        <main class="dashboard">
            <div class="card text-center mb-5 admin-hero">
                <h2 class="text-2xl font-bold mb-2">üõ°Ô∏è Admin Control Panel</h2>
                <p>Manage campaigns, approve submissions, and monitor system stats</p>
            </div>

            <div class="admin-header__actions flex gap-3 mb-5 pb-4 admin-nav-border">
                <button class="btn btn--primary admin-nav__tab admin-nav__tab--active" data-section="overview">üìä Overview</button>
                <button class="btn btn--secondary admin-nav__tab" data-section="campaigns">üìã All Campaigns</button>
                <button class="btn btn--secondary admin-nav__tab" data-section="pending">‚è≥ Pending Approval</button>
                <button class="btn btn--secondary admin-nav__tab" data-section="create">‚ûï Create Campaign</button>
                <button class="btn btn--secondary admin-nav__tab" data-section="features">üö© Feature Flags</button>
            </div>

            <!-- Overview Section -->
            <div id="overview" class="admin-section admin-section--active">
                <h3 class="text-xl font-bold mb-4">System Overview</h3>
                <div class="admin-stats grid grid-cols-4 gap-4 mb-5">
                    <div class="admin-stats__card card text-center">
                        <div class="admin-stats__card__number text-2xl font-bold text-primary" id="totalCampaigns">-</div>
                        <div class="admin-stats__card__label text-secondary mt-2">Total Campaigns</div>
                    </div>
                    <div class="admin-stats__card card text-center">
                        <div class="admin-stats__card__number text-2xl font-bold text-primary" id="pendingCampaigns">-</div>
                        <div class="admin-stats__card__label text-secondary mt-2">Pending Approval</div>
                    </div>
                    <div class="admin-stats__card card text-center">
                        <div class="admin-stats__card__number text-2xl font-bold text-primary" id="activeCampaigns">-</div>
                        <div class="admin-stats__card__label text-secondary mt-2">Active Campaigns</div>
                    </div>
                    <div class="admin-stats__card card text-center">
                        <div class="admin-stats__card__number text-2xl font-bold text-primary" id="totalUsers">-</div>
                        <div class="admin-stats__card__label text-secondary mt-2">Total Users</div>
                    </div>
                </div>
                <p class="text-secondary">Select a tab above to manage specific areas of the system.</p>
            </div>

            <!-- All Campaigns Section -->
            <div id="campaigns" class="admin-section">
                <h3 class="text-xl font-bold mb-4">All Campaigns</h3>
                <div id="allCampaignsGrid">
                    <p class="text-secondary">Loading campaigns...</p>
                </div>
            </div>

            <!-- Pending Campaigns Section -->
            <div id="pending" class="admin-section">
                <h3 class="text-xl font-bold mb-4">Pending Approval</h3>
                <div id="pendingCampaignsGrid">
                    <p class="text-secondary">Loading pending campaigns...</p>
                </div>
            </div>

            <!-- Feature Flags Section -->
            <div id="features" class="admin-section">
                <h3 class="text-xl font-bold mb-4">üö© Feature Flags Management</h3>
                
                <div class="card mb-5">
                    <h4 class="card__title mb-3">Premium Feature Controls</h4>
                    <p class="text-secondary mb-4">Toggle premium features on/off and simulate user tiers for testing.</p>
                    
                    <div id="featureFlagsGrid" class="grid grid-cols-1 gap-4">
                        <p class="text-secondary">Loading feature flags...</p>
                    </div>
                </div>
                
                <div class="card">
                    <h4 class="card__title mb-3">User Tier Simulation</h4>
                    <p class="text-secondary mb-4">Change user tiers for testing premium features.</p>
                    
                    <div class="flex gap-3 items-end">
                        <div class="form-group flex-1">
                            <label for="simulateUserId">User Email/ID:</label>
                            <input type="text" id="simulateUserId" placeholder="Enter user email or ID" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="simulateTier">New Tier:</label>
                            <select id="simulateTier" class="form-input">
                                <option value="Free">Free</option>
                                <option value="Premium">Premium</option>
                            </select>
                        </div>
                        <button id="simulateTierBtn" class="btn btn--primary">Update Tier</button>
                    </div>
                </div>
            </div>

            <!-- Create Campaign Section -->
            <div id="create" class="admin-section">
                <h3 class="text-xl font-bold mb-4">Create New Campaign</h3>
                <div class="card create-form-container">
                    <form id="createCampaignForm">
                        <div class="form-group">
                            <label for="createName">Campaign Name</label>
                            <input type="text" id="createName" required placeholder="e.g., Thank Local Coffee Shops">
                        </div>
                        
                        <div class="form-group">
                            <label for="createDescription">Description</label>
                            <textarea id="createDescription" required placeholder="Brief description of what this campaign is about..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="createExpiration">Expiration Date</label>
                            <input type="datetime-local" id="createExpiration" required>
                        </div>

                        <div class="form-group">
                            <label>Recipients</label>
                            <div id="createRecipientsList" class="card p-3 recipients-list">
                                <p class="text-secondary">No recipients added yet. Add recipients below.</p>
                            </div>
                            <div class="flex gap-2 mb-3">
                                <input type="email" id="createRecipientEmail" placeholder="Enter email address" class="flex-1">
                                <input type="text" id="createRecipientName" placeholder="Display name (optional)" class="flex-1">
                                <button type="button" id="createAddRecipient" class="btn btn--success">Add</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="createStatus">Status</label>
                            <select id="createStatus" required>
                                <option value="Active">Active (Ready to send)</option>
                                <option value="Pending">Pending (Requires approval)</option>
                            </select>
                            <p class="text-secondary text-sm mt-1">
                                As an admin, you can create campaigns that are immediately active or require approval.
                            </p>
                        </div>
                        
                        <div class="flex gap-3 justify-end mt-5">
                            <button type="button" id="resetCreateForm" class="btn btn--secondary">Reset Form</button>
                            <button type="submit" class="btn btn--primary">Create Campaign</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>&copy; 2024 ReallyGoodJob. Admin Panel</p>
        </footer>
    </div>

    <!-- Edit Campaign Modal -->
    <div id="editModal" class="modal">
        <div class="modal__content">
            <div class="modal__header">
                <h3>Edit Campaign</h3>
                <span class="close" id="closeEditModal">&times;</span>
            </div>
            <div class="modal__body">
                <form id="editForm">
                    <input type="hidden" id="editCampaignId">
                    
                    <div class="form-group">
                        <label for="editName">Campaign Name</label>
                        <input type="text" id="editName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editDescription">Description</label>
                        <textarea id="editDescription" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="editExpiration">Expiration Date</label>
                        <input type="datetime-local" id="editExpiration" required>
                    </div>

                    <div class="form-group">
                        <label>Recipients</label>
                        <div id="recipientsList" class="card p-3 recipients-list--modal">
                            <p class="text-secondary">Loading recipients...</p>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <input type="email" id="newRecipientEmail" class="flex-1" placeholder="Enter email address">
                            <input type="text" id="newRecipientName" class="flex-1" placeholder="Display name (optional)">
                            <button type="button" id="addRecipient" class="btn btn--success">Add</button>
                        </div>
                    </div>
                    
                    <div class="modal__actions">
                        <button type="button" id="cancelEdit" class="btn btn--secondary">Cancel</button>
                        <button type="submit" class="btn btn--primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Get JWT token
        const token = localStorage.getItem('authToken');
        
        if (!token) {
            window.location.href = '/?error=authentication_required';
        }

        // State
        let currentSection = 'overview';
        let allCampaigns = [];
        let pendingCampaigns = [];

        // Navigation
        document.querySelectorAll('.admin-nav__tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const section = tab.dataset.section;
                switchSection(section);
            });
        });

        function switchSection(section) {
            // Update nav
            document.querySelectorAll('.admin-nav__tab').forEach(tab => {
                const isActive = tab.dataset.section === section;
                tab.classList.toggle('admin-nav__tab--active', isActive);
                tab.classList.toggle('btn--primary', isActive);
                tab.classList.toggle('btn--secondary', !isActive);
            });
            
            // Update sections
            document.querySelectorAll('.admin-section').forEach(sec => {
                sec.classList.toggle('admin-section--active', sec.id === section);
            });
            
            currentSection = section;
            
            // Load data for section
            if (section === 'campaigns') {
                loadAllCampaigns();
            } else if (section === 'pending') {
                loadPendingCampaigns();
            } else if (section === 'overview') {
                loadStats();
            } else if (section === 'create') {
                initializeCreateForm();
            } else if (section === 'features') {
                loadFeatureFlags();
            }
        }

        // Load admin stats
        async function loadStats() {
            try {
                const response = await fetch('/api/admin/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to load stats');
                
                const data = await response.json();
                const stats = data.stats;
                
                document.getElementById('totalCampaigns').textContent = stats.campaigns.total;
                document.getElementById('pendingCampaigns').textContent = stats.campaigns.pending;
                document.getElementById('activeCampaigns').textContent = stats.campaigns.active;
                document.getElementById('totalUsers').textContent = stats.users.total;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load all campaigns
        async function loadAllCampaigns() {
            try {
                const response = await fetch('/api/admin/campaigns', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to load campaigns');
                
                const data = await response.json();
                allCampaigns = data.campaigns;
                renderCampaigns(allCampaigns, 'allCampaignsGrid', true);
            } catch (error) {
                console.error('Error loading campaigns:', error);
                document.getElementById('allCampaignsGrid').innerHTML = '<p class="text-error">Error loading campaigns</p>';
            }
        }

        // Load pending campaigns
        async function loadPendingCampaigns() {
            try {
                const response = await fetch('/api/admin/campaigns/pending', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to load pending campaigns');
                
                const data = await response.json();
                pendingCampaigns = data.campaigns;
                renderCampaigns(pendingCampaigns, 'pendingCampaignsGrid', false);
            } catch (error) {
                console.error('Error loading pending campaigns:', error);
                document.getElementById('pendingCampaignsGrid').innerHTML = '<p class="text-error">Error loading pending campaigns</p>';
            }
        }

        // Render campaigns
        function renderCampaigns(campaigns, containerId, showEdit) {
            const container = document.getElementById(containerId);
            
            if (campaigns.length === 0) {
                container.innerHTML = '<p class="text-secondary">No campaigns found</p>';
                return;
            }
            
            container.innerHTML = campaigns.map(campaign => `
                <div class="card mb-4">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h4 class="card__title mb-2">${campaign.name}</h4>
                            <p class="text-secondary mb-3">${campaign.description}</p>
                            <div class="flex gap-3 items-center mb-2">
                                <span class="status-badge status-badge--${campaign.status.toLowerCase()}">${campaign.status}</span>
                                <span class="text-secondary text-sm">üìß ${campaign.recipientCount} recipients</span>
                                <span class="text-secondary text-sm">üë§ ${campaign.createdBy.name}</span>
                            </div>
                            <div class="text-muted text-sm">
                                Created: ${new Date(campaign.createdAt).toLocaleDateString()}
                                ${campaign.approvedAt ? `‚Ä¢ Approved: ${new Date(campaign.approvedAt).toLocaleDateString()}` : ''}
                                ‚Ä¢ Expires: ${new Date(campaign.expirationAt).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="flex gap-2">
                            ${showEdit ? `<button class="btn btn--small btn--primary" data-action="edit" data-campaign-id="${campaign.id}">Edit</button>` : ''}
                            ${campaign.status === 'Pending' ? `
                                <button class="btn btn--small btn--success" data-action="approve" data-campaign-id="${campaign.id}">Approve</button>
                                <button class="btn btn--small btn--error" data-action="reject" data-campaign-id="${campaign.id}">Reject</button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // State for recipients
        let currentRecipients = [];
        let createRecipients = [];

        // Edit campaign
        async function editCampaign(campaignId) {
            const campaign = allCampaigns.find(c => c.id === campaignId);
            if (!campaign) return;
            
            document.getElementById('editCampaignId').value = campaign.id;
            document.getElementById('editName').value = campaign.name;
            document.getElementById('editDescription').value = campaign.description;
            document.getElementById('editExpiration').value = new Date(campaign.expirationAt).toISOString().slice(0, 16);
            
            // Load recipients for this campaign
            await loadCampaignRecipients(campaignId);
            
            document.getElementById('editModal').classList.add('active');
        }

        // Load campaign recipients
        async function loadCampaignRecipients(campaignId) {
            try {
                const response = await fetch(`/api/admin/campaigns/${campaignId}/recipients`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to load recipients');
                
                const data = await response.json();
                currentRecipients = data.recipients || [];
                renderRecipients();
            } catch (error) {
                console.error('Error loading recipients:', error);
                document.getElementById('recipientsList').innerHTML = '<p class="text-error">Error loading recipients</p>';
            }
        }

        // Render recipients list
        function renderRecipients() {
            const container = document.getElementById('recipientsList');
            
            if (currentRecipients.length === 0) {
                container.innerHTML = '<p class="text-secondary">No recipients added yet.</p>';
                return;
            }
            
            container.innerHTML = currentRecipients.map((recipient, index) => `
                <div class="flex justify-between items-center p-2 mb-2 bg-secondary border rounded" data-index="${index}">
                    <div class="flex-1">
                        <div class="font-bold text-primary">${recipient.email}</div>
                        ${recipient.displayName ? `<div class="text-sm text-secondary">${recipient.displayName}</div>` : ''}
                    </div>
                    <button class="btn btn--small btn--error" data-action="remove-recipient" data-index="${index}">Remove</button>
                </div>
            `).join('');
        }

        // Add recipient
        function addRecipient() {
            const email = document.getElementById('newRecipientEmail').value.trim();
            const displayName = document.getElementById('newRecipientName').value.trim();
            
            if (!email) {
                alert('Please enter an email address');
                return;
            }
            
            if (!email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }
            
            // Check for duplicates
            if (currentRecipients.some(r => r.email.toLowerCase() === email.toLowerCase())) {
                alert('This email address is already in the recipients list');
                return;
            }
            
            currentRecipients.push({
                email: email,
                displayName: displayName || null,
                isNew: true
            });
            
            // Clear inputs
            document.getElementById('newRecipientEmail').value = '';
            document.getElementById('newRecipientName').value = '';
            
            renderRecipients();
        }

        // Remove recipient
        function removeRecipient(index) {
            currentRecipients.splice(index, 1);
            renderRecipients();
        }

        // Approve campaign
        async function approveCampaign(campaignId) {
            if (!confirm('Are you sure you want to approve this campaign?')) return;
            
            try {
                const response = await fetch(`/api/admin/campaigns/${campaignId}/approve`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to approve campaign');
                
                alert('Campaign approved successfully!');
                
                // Refresh current view
                if (currentSection === 'campaigns') loadAllCampaigns();
                if (currentSection === 'pending') loadPendingCampaigns();
                loadStats();
            } catch (error) {
                console.error('Error approving campaign:', error);
                alert('Failed to approve campaign');
            }
        }

        // Reject campaign
        async function rejectCampaign(campaignId) {
            const reason = prompt('Reason for rejection (optional):');
            if (reason === null) return; // User cancelled
            
            try {
                const response = await fetch(`/api/admin/campaigns/${campaignId}/reject`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason })
                });
                
                if (!response.ok) throw new Error('Failed to reject campaign');
                
                alert('Campaign rejected successfully!');
                
                // Refresh current view
                if (currentSection === 'campaigns') loadAllCampaigns();
                if (currentSection === 'pending') loadPendingCampaigns();
                loadStats();
            } catch (error) {
                console.error('Error rejecting campaign:', error);
                alert('Failed to reject campaign');
            }
        }

        // Initialize create form
        function initializeCreateForm() {
            // Set default expiration to 30 days from now
            const defaultExpiration = new Date();
            defaultExpiration.setDate(defaultExpiration.getDate() + 30);
            defaultExpiration.setHours(23, 59, 0, 0);
            document.getElementById('createExpiration').value = defaultExpiration.toISOString().slice(0, 16);
            
            // Reset recipients
            createRecipients = [];
            renderCreateRecipients();
        }

        // Add recipient to create form
        function addCreateRecipient() {
            const email = document.getElementById('createRecipientEmail').value.trim();
            const displayName = document.getElementById('createRecipientName').value.trim();
            
            if (!email) {
                alert('Please enter an email address');
                return;
            }
            
            if (!email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }
            
            // Check for duplicates
            if (createRecipients.some(r => r.email.toLowerCase() === email.toLowerCase())) {
                alert('This email address is already in the recipients list');
                return;
            }
            
            createRecipients.push({
                email: email,
                displayName: displayName || null
            });
            
            // Clear inputs
            document.getElementById('createRecipientEmail').value = '';
            document.getElementById('createRecipientName').value = '';
            
            renderCreateRecipients();
        }

        // Remove recipient from create form
        function removeCreateRecipient(index) {
            createRecipients.splice(index, 1);
            renderCreateRecipients();
        }

        // Render create recipients list
        function renderCreateRecipients() {
            const container = document.getElementById('createRecipientsList');
            
            if (createRecipients.length === 0) {
                container.innerHTML = '<p class="text-secondary">No recipients added yet. Add recipients below.</p>';
                return;
            }
            
            container.innerHTML = createRecipients.map((recipient, index) => `
                <div class="flex justify-between items-center p-2 mb-2 bg-secondary border rounded" data-index="${index}">
                    <div class="flex-1">
                        <div class="font-bold text-primary">${recipient.email}</div>
                        ${recipient.displayName ? `<div class="text-sm text-secondary">${recipient.displayName}</div>` : ''}
                    </div>
                    <button class="btn btn--small btn--error" data-action="remove-create-recipient" data-index="${index}">Remove</button>
                </div>
            `).join('');
        }

        // Reset create form
        function resetCreateForm() {
            document.getElementById('createCampaignForm').reset();
            createRecipients = [];
            initializeCreateForm();
        }

        // Create campaign
        async function createCampaign(formData) {
            try {
                const response = await fetch('/api/admin/campaigns/create', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create campaign');
                }
                
                const result = await response.json();
                alert(`Campaign "${formData.name}" created successfully!`);
                
                // Reset form and switch to campaigns view
                resetCreateForm();
                switchSection('campaigns');
                
                return result;
            } catch (error) {
                console.error('Error creating campaign:', error);
                alert('Failed to create campaign: ' + error.message);
            }
        }

        // Modal controls
        document.getElementById('cancelEdit').addEventListener('click', () => {
            document.getElementById('editModal').classList.remove('active');
        });

        document.getElementById('closeEditModal').addEventListener('click', () => {
            document.getElementById('editModal').classList.remove('active');
        });

        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target.id === 'editModal') {
                document.getElementById('editModal').classList.remove('active');
            }
        });

        // Edit form submission
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const campaignId = document.getElementById('editCampaignId').value;
            const name = document.getElementById('editName').value;
            const description = document.getElementById('editDescription').value;
            const expirationAt = document.getElementById('editExpiration').value;
            
            try {
                // Update campaign details
                const campaignResponse = await fetch(`/api/admin/campaigns/${campaignId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, description, expirationAt })
                });
                
                if (!campaignResponse.ok) throw new Error('Failed to update campaign');

                // Update recipients
                const recipientsResponse = await fetch(`/api/admin/campaigns/${campaignId}/recipients`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ recipients: currentRecipients })
                });
                
                if (!recipientsResponse.ok) throw new Error('Failed to update recipients');
                
                alert('Campaign and recipients updated successfully!');
                document.getElementById('editModal').classList.remove('active');
                
                // Refresh current view
                if (currentSection === 'campaigns') loadAllCampaigns();
                if (currentSection === 'pending') loadPendingCampaigns();
            } catch (error) {
                console.error('Error updating campaign:', error);
                alert('Failed to update campaign: ' + error.message);
            }
        });

        // Load user info
        async function loadUserInfo() {
            try {
                const response = await fetch('/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to load user info');
                
                const user = await response.json();
                
                if (!user.isAdmin) {
                    alert('Admin access required');
                    window.location.href = '/dashboard';
                    return;
                }
                
                document.getElementById('adminEmail').textContent = user.email;
            } catch (error) {
                console.error('Error loading user info:', error);
                window.location.href = '/?error=session_expired';
            }
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await fetch('/auth/logout', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                localStorage.removeItem('authToken');
                window.location.href = '/';
            }
        });

        // Event delegation for campaign action buttons
        document.addEventListener('click', (e) => {
            const target = e.target;
            if (target.matches('[data-action]')) {
                const action = target.dataset.action;
                const campaignId = target.dataset.campaignId;
                const index = target.dataset.index;
                
                switch (action) {
                    case 'edit':
                        editCampaign(campaignId);
                        break;
                    case 'approve':
                        approveCampaign(campaignId);
                        break;
                    case 'reject':
                        rejectCampaign(campaignId);
                        break;
                    case 'remove-recipient':
                        removeRecipient(parseInt(index));
                        break;
                    case 'remove-create-recipient':
                        removeCreateRecipient(parseInt(index));
                        break;
                }
            }
        });

        // Add recipient button
        document.getElementById('addRecipient').addEventListener('click', addRecipient);

        // Allow Enter key to add recipient
        document.getElementById('newRecipientEmail').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addRecipient();
            }
        });

        // Create campaign form events
        document.getElementById('createAddRecipient').addEventListener('click', addCreateRecipient);
        document.getElementById('resetCreateForm').addEventListener('click', resetCreateForm);
        
        // Allow Enter key to add recipient in create form
        document.getElementById('createRecipientEmail').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addCreateRecipient();
            }
        });

        // Create campaign form submission
        document.getElementById('createCampaignForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('createName').value.trim();
            const description = document.getElementById('createDescription').value.trim();
            const expirationAt = document.getElementById('createExpiration').value;
            const status = document.getElementById('createStatus').value;
            
            if (!name || !description || !expirationAt) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (createRecipients.length === 0) {
                alert('Please add at least one recipient');
                return;
            }
            
            const formData = {
                name,
                description,
                expirationAt,
                status,
                recipients: createRecipients
            };
            
            await createCampaign(formData);
        });

        // Feature Flags Management
        async function loadFeatureFlags() {
            try {
                const response = await fetch('/api/features/flags', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to load feature flags');
                
                const data = await response.json();
                renderFeatureFlags(data.flags, data.descriptions);
            } catch (error) {
                console.error('Error loading feature flags:', error);
                document.getElementById('featureFlagsGrid').innerHTML = '<p class="text-error">Error loading feature flags</p>';
            }
        }

        function renderFeatureFlags(flags, descriptions) {
            const container = document.getElementById('featureFlagsGrid');
            
            container.innerHTML = Object.entries(flags).map(([flagName, isEnabled]) => `
                <div class="card p-4">
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <h5 class="font-bold mb-1">${flagName}</h5>
                            <p class="text-secondary text-sm">${descriptions[flagName] || 'No description available'}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="status-badge status-badge--${isEnabled ? 'success' : 'error'}">
                                ${isEnabled ? 'Enabled' : 'Disabled'}
                            </span>
                            <button 
                                class="btn btn--small ${isEnabled ? 'btn--error' : 'btn--success'}" 
                                data-action="toggle-flag" 
                                data-flag-name="${flagName}"
                            >
                                ${isEnabled ? 'Disable' : 'Enable'}
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function toggleFeatureFlag(flagName) {
            try {
                const response = await fetch('/api/features/toggle', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ flagName })
                });
                
                if (!response.ok) throw new Error('Failed to toggle feature flag');
                
                const result = await response.json();
                alert(`Feature flag ${flagName} is now ${result.newValue ? 'enabled' : 'disabled'}`);
                
                // Reload feature flags
                loadFeatureFlags();
            } catch (error) {
                console.error('Error toggling feature flag:', error);
                alert('Failed to toggle feature flag: ' + error.message);
            }
        }

        async function simulateUserTier() {
            const userIdInput = document.getElementById('simulateUserId').value.trim();
            const tier = document.getElementById('simulateTier').value;
            
            if (!userIdInput) {
                alert('Please enter a user email or ID');
                return;
            }
            
            try {
                const response = await fetch('/api/features/simulate-tier', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        userId: userIdInput,
                        tier: tier 
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to simulate user tier');
                }
                
                const result = await response.json();
                alert(`User ${result.user.email} tier changed to ${result.user.tier}`);
                
                // Clear form
                document.getElementById('simulateUserId').value = '';
                document.getElementById('simulateTier').value = 'Free';
            } catch (error) {
                console.error('Error simulating user tier:', error);
                alert('Failed to simulate user tier: ' + error.message);
            }
        }

        // Feature flag event handlers
        document.addEventListener('click', (e) => {
            if (e.target.matches('[data-action="toggle-flag"]')) {
                const flagName = e.target.dataset.flagName;
                toggleFeatureFlag(flagName);
            }
        });

        document.getElementById('simulateTierBtn').addEventListener('click', simulateUserTier);

        // Initialize
        loadUserInfo();
        loadStats();
    </script>
</body>
</html> 